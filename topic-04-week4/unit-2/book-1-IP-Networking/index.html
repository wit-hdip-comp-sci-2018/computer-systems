

<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-rc.10/css/uikit.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-rc.10/js/uikit.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-rc.10/js/uikit-icons.min.js"></script>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/railscasts.min.css"/>
    <script defer src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/java.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </head>
  <style>
    

body {
  font-family: "Open Sans", "Helvetica", "Helvetica Neue",  "Arial", sans-serif;
  font-size:90%;
  color: black;
}

p {
  margin: 0.5em;
}

pre code {
  font-family: "Monaco";
  font-size: 100%;
}

img {
  box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
  margin:10px;
}

h1, h2, h3 {
  border-bottom:thin solid black;
  margin-bottom: 0.5em;
  margin-top: 1em;
}

h1 {
  font-style:italic;
  font-size:130%;
}

h2 {
  font-size:110%;
}

h3 {
  font-size:100%;
}



  </style>

  <body class="lab">

    
  <div class="uk-offcanvas-content">
    <div id="offcanvas-usage" uk-offcanvas>
      <div class="uk-offcanvas-bar">
        <button class="uk-offcanvas-close" type="button" uk-close></button>
        <ul class="uk-nav">
          
            
              <li>
                <a class="item" href="http://wit-hdip-comp-sci-2018.github.io/computer-systems//topic-00-open-day/book-1/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Preparatory Lab
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="http://wit-hdip-comp-sci-2018.github.io/computer-systems//topic-00-open-day/book-2/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Shell Scripting
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="http://wit-hdip-comp-sci-2018.github.io/computer-systems//topic-00-open-day/book-3/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Vagrant and Sense HAT
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="http://wit-hdip-comp-sci-2018.github.io/computer-systems//unit-1/book-a/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Linux Practice Exercises
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="http://wit-hdip-comp-sci-2018.github.io/computer-systems//unit-2/book-a/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Home Network
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="http://wit-hdip-comp-sci-2018.github.io/computer-systems//unit-1/book-a/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Scripting Exercises
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="http://wit-hdip-comp-sci-2018.github.io/computer-systems//unit-2/book-1-vagrant/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Vagrant and Virtualisation
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="http://wit-hdip-comp-sci-2018.github.io/computer-systems//unit-1/book-a/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
CPU
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="http://wit-hdip-comp-sci-2018.github.io/computer-systems//unit-2/book-1-packet-sniffing/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Packet Sniffing using TShark
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="http://wit-hdip-comp-sci-2018.github.io/computer-systems//unit-1/book-a/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Labs
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="http://wit-hdip-comp-sci-2018.github.io/computer-systems//unit-2/book-1-IP-Networking/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
IP Networking
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="http://wit-hdip-comp-sci-2018.github.io/computer-systems//unit-1/book-a/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Labs
                </a>
              </li>
            
          
        </ul>
      </div>
    </div>
  </div>


    <div uk-sticky>
      <nav class="uk-navbar">
        <div class="uk-navbar-left">
          <ul class="uk-subnav uk-background-secondary uk-subnav-pill">
            <li><a href="#offcanvas-usage" uk-icon="icon: menu" , uk-toggle title="Switch Lab" pos="bottom"
                   uk-tooltip></a></li>
             }}
              <li class="uk-active"><a href="../../index.html" uk-icon="icon: chevron-up" uk-toggle title="Parent Topic"
                                       pos="bottom" uk-tooltip> Networking </a></li>
            
          </ul>
        </div>
        <div class="uk-navbar-right">
          <ul class="uk-subnav uk-background-secondary uk-subnav-pill"
              uk-switcher="connect: .switcher-container">
            
              <li><a href="#">IP Networking</a></li>
            
              <li><a href="#">01</a></li>
            
              <li><a href="#">02</a></li>
            
              <li><a href="#">03</a></li>
            
              <li><a href="#">04</a></li>
            
              <li><a href="#">05</a></li>
            
          </ul>
        </div>
      </nav>
    </div>

    <div class="uk-container uk-container-expand">
      <ul class="uk-switcher switcher-container">
        
          <li> <h1>Private and Public IP Networks</h1>
<p>Use Vagrant to set up a simulated provate/public network topology.</p>
</li>
        
          <li> <h2>Objectives</h2>
<p>In this lab, you will:</p>
<ul>
<li>Review a simple multi-machine network consisting of machines on different subnets</li>
<li>Create a private network using Vagrant</li>
<li>Create a bridged network interface using Vagrant</li>
<li>Test and validate the connectivity between different subnets.</li>
</ul>
<h3>Required Resources</h3>
<ul>
<li>2 devices on the same LAN with Internet Access (e.g. Laptop and Smart Phone)</li>
<li>VirtualBox/Vagrant</li>
<li>Complete last week3 lab - Vagrant and Virtualisation </li>
</ul>
</li>
        
          <li> <h1>Virtual private network</h1>
<p>You will no create a virtual networking topology similar to the one you created in last weeks (week3) lab, including your home router. Although we are doing this lab &quot;virtually&quot;,  the concepts can be applied in any IP network. The lab assumes that Vagrant is running in the host laptop.</p>
<h2>Set up Virtual Network</h2>
<ol>
<li>Create a lab directory called <strong>cs-nets-lab4</strong>.</li>
<li>Open a terminal window in the directory and run <code>vagrant init</code> to initialise it as a vagrant project</li>
<li>Replace the contents of the Vagrantfile with the code from last weeks lab and modify machine names and network configuration according to the following code:</li>
</ol>
<pre><code class="lang-ruby">VAGRANTFILE_API_VERSION = &quot;2&quot;
Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|
config.vm.define &quot;WebServer&quot; do |pc0|
pc0.vm.hostname = &quot;WebServer&quot;
pc0.vm.network :private_network, ip: &quot;10.0.1.2&quot;, :netmask =&gt; &quot;255.255.255.0&quot;
end
config.vm.define &quot;DBServer&quot; do |pc1|
pc1.vm.hostname = &quot;DBServer&quot;
pc1.vm.network :private_network, ip: &quot;10.0.1.3&quot;, :netmask =&gt; &quot;255.255.255.0&quot;
end
config.vm.box = &quot;frankwalsh/labvm&quot;
config.ssh.forward_x11 = true
end</code></pre>
<ul>
<li>The Vagrant file shows network configuration in dot decimal form. Calculate the binary representation of the DBServer&#39;s IP address and network mask.  </li>
<li>Calculate the network address of the private network in prefix format (e.g. 121.145.2.0/26)  </li>
</ul>
<p>Start the virtual environment in the usual way:  </p>
<pre><code class="lang-bash">$ vagrant up</code></pre>
<p>The Vagrantfile will create the following network topology consisting of two linux machines connected using a private network (10.0.1.0/24).</p>
<p><img src="./img/vagrant-private.png" alt="Virtual Machine Topology"></p>
<ul>
<li>Check if you can &quot;see&quot; the new VMs. <strong>From your host,</strong> Ping both using the IP addresses you assigned to them in your Vagrantfile.  </li>
</ul>
<pre><code class="lang-bash">ping 10.0.1.2

ping 10.0.1.3</code></pre>
<p>Both should respond successfully as before.</p>
<p>You will now try to interact with these machines from another device on your home network, for example you Smart Phone.</p>
</li>
        
          <li> <h2>Accessing the private network</h2>
<p>In the previous slide, you pinged both VMs successfully from your host machine. Now try the same from another device on your LAN. This can be and device capable of issuing an ICMP request such as:</p>
<ul>
<li>Mobile Phone</li>
<li>Another Laptop/desktop machine</li>
<li>Your Raspberry Pi(if you have it up and running)</li>
</ul>
<h3>SmartPhones</h3>
<p>Download an app that allows you to ping devices on your LAN. The following are available for free (iPhone app not tested with this lab):</p>
<p><a href="https://play.google.com/store/apps/details?id=com.androidping.app&amp;hl=en"><img src="./img/ping.png" alt="Android App"></a> 
<a href="https://itunes.apple.com/us/app/network-ping-lite/id289967115?mt=8"><img src="./img/pinglite.png" alt="iPhone App"></a>  </p>
<h3>Ping away...</h3>
<p>Now find the IP address of the <strong>host machine</strong>, the machine that is running Virtualbox and hosting your VMs(probably your laptop).  </p>
<ul>
<li>Use a different device on your Home network to ping your host address. You should get a successful response. An example using Ping for android is shown below. </li>
</ul>
<p><img src="./img/ping-ss.png" alt="Ping Screenshot"></p>
<ul>
<li>Now, on your host machine, use vagrant to SSH into your WebServer VM and get the interface configuration as follows:  </li>
</ul>
<pre><code class="lang-bash">$ vagrant ssh WebServer
Welcome to Ubuntu 14.04.5 LTS (GNU/Linux 3.13.0-144-generic x86_64)
.
.
.
.
vagrant@webserver:~$ ifconfig
eth0      Link encap:Ethernet  HWaddr 08:00:27:1b:25:c4  
          inet addr:10.0.2.15  Bcast:10.0.2.255  Mask:255.255.255.0
          inet6 addr: fe80::a00:27ff:fe1b:25c4/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:594 errors:0 dropped:0 overruns:0 frame:0
          TX packets:495 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:61789 (61.7 KB)  TX bytes:58920 (58.9 KB)

eth1      Link encap:Ethernet  HWaddr 08:00:27:97:fd:d7  
          inet addr:10.0.1.2  Bcast:10.0.1.255  Mask:255.255.255.0
          inet6 addr: fe80::a00:27ff:fe97:fdd7/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:5 errors:0 dropped:0 overruns:0 frame:0
          TX packets:18 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:1225 (1.2 KB)  TX bytes:1596 (1.5 KB)

lo        Link encap:Local Loopback  
          inet addr:127.0.0.1  Mask:255.0.0.0
          inet6 addr: ::1/128 Scope:Host
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:16 errors:0 dropped:0 overruns:0 frame:0
          TX packets:16 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:1184 (1.1 KB)  TX bytes:1184 (1.1 KB)</code></pre>
<ul>
<li>From the lecture videos, what is the significance of the <strong>lo</strong> interface. </li>
<li>Try to ping any of the interfaces on the webserver VM using the same device you used to ping your host. Does it work? Hopefully not! You should see output similar to the folowing</li>
</ul>
<p><img src="./img/ping-ss2.png" alt="Ping Screenshot"></p>
<p>Before going any further, try to explain why you cannot &quot;see&quot; the web server VM outside the host.</p>
</li>
        
          <li> <h1>Private and public Networks</h1>
<p>At the moment it&#39;s not possible to access any of your VMs from external devices on your LAN at home.<br>We would like the web server to be accessible from external networks, if only to access web resources. However, we&#39;d like the DBServer to remain isolated and only accessible from the private network. Furthermore, it should not be possible to access external networks or the internet from the DBServer. </p>
<p>To allow access to the WebServer, you can add a <strong>public network</strong> interface. This will create a bridged network(remember Week 2, virtualisation) such as the Web Server will appear like any other host on the LAN. It&#39;s worth saying, do not confuse this <strong>public network</strong> with the public IP network - it&#39;s just what Vagrant uses to describe bridging using the host interface. </p>
<h2>Subnets</h2>
<p>You will separate the DB Server and Web Server into different subnets. A reason for this might be to separate them into different administrative networks due to access and security requirements(we will not concern ourselves with this here!). 
We can subnet the 10.0.1.0/24 network into:
10.0.1.0/25
10.0.1.126/25</p>
<p>Update the Vagrantfile to include the public network and new subnet configuration highlighted below:</p>
<pre><code class="lang-bash">VAGRANTFILE_API_VERSION = &quot;2&quot;
Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|
    config.vm.define &quot;WebServer&quot; do |pc0|
        pc0.vm.hostname = &quot;WebServer&quot;
        pc0.vm.network :private_network, ip: &quot;10.0.1.0&quot;, :netmask =&gt; &quot;255.255.255.128&quot;
        # Public Network (bridged)
        pc0.vm.network &quot;public_network&quot;
    end
    config.vm.define &quot;DBServer&quot; do |pc1|
        pc1.vm.hostname = &quot;DBServer&quot;
        pc1.vm.network :private_network, ip: &quot;10.0.1.128&quot;, :netmask =&gt; &quot;255.255.255.128&quot;
    end
    config.vm.box = &quot;frankwalsh/labvm&quot;
    config.ssh.forward_x11 = true
end</code></pre>
<p>During the update you may be asked to select the interface on your host machine you wish to use for bridging. <strong>Make sure to use the interface you&#39;re currently using to connect to your LAN and the Internet</strong>.
Once finished, SSH into the web server as before and check the interface configuration using <code>ifconfig</code> again. You should now have another interface on the machine that is on the same network as your host machine. Effectively you&#39;ve created a new network interface in software that looks to the host system as though the Web Server VM  is physically connected to the interface using a network cable. This means that you can connect between the Web Server VM and the rest of your network. Your interface config on the Web Server VM should look something similar to the following: 
<img src="./img/bridged.png" alt="Bridged Interface">
The Web server now has a (virtual) network interface on the hosts LAN and has baan assigned an address from the DHCP service on that LAN.</p>
<h3>Ping again</h3>
<p>Now try to ping the Web Server VM from another device on your LAN using the IP address assigned to the bridged interface(eth2 in the above example). This time it should work.<br><img src="./img/ping3.png" alt="Ping bridged interface">
You still will not be able to ping the DB Server as it is only connected to the <strong>private network</strong>.</p>
<p>To get the VM to act somewhat like a real web server, you can start a simple process that listens on port 80 on the Web Server VM and returns a simple HTML page. </p>
<ul>
<li><p>Create a simple HTML page called <code>index.html</code> in the home directory of your Web Server VM</p>
<pre><code class="lang-bash">vagrant@webserver:~$ echo &#39;&lt;html&gt;&lt;head&gt;&lt;title&gt;Web Server Test&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Hello from your Web Server VM!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&#39; &gt; index.html</code></pre>
</li>
<li><p>Using the <a href="https://www.commandlinux.com/man-page/man1/nc.1.html">netcat command</a>, run a short script at the command line to listen for(-l) a connection on port 80 (-p) and return the index.html page.</p>
</li>
</ul>
<pre><code class="lang-bash">vagrant@webserver:~$ while true; do echo -e &quot;HTTP/1.1 200 OK\r\nContent-Type: text/html\r\n\r\n&quot; | cat - index.html  | sudo nc -l -p 80; done</code></pre>
<ul>
<li>Now, from a browser on your host machine(or any other machine on your LAN), make a request to the Web Server by just putting the IP address into the address bar. You should see similar the following:
<img src="./img/webpage.png" alt="Web Server page"></li>
</ul>
</li>
        
          <li> <h1>DB Server</h1>
<p>The DB server should be isolated from public networks. There should be no routing from external networks to the DB Server. Similarly, there is no need for external access from the DB Server to the internet (perhaps for security reasons).</p>
<ul>
<li>SSH into the DB Server and try to retrieve the google.ie
web page  </li>
</ul>
<pre><code class="lang-bash">vagrant@dbserver:~$ wget google.ie
--2018-10-02 10:09:51--  http://google.ie/
Resolving google.ie (google.ie)... 74.125.90.67, 2a00:1450:400b:803::2003
Connecting to google.ie (google.ie)|74.125.90.67|:80... connected.
HTTP request sent, awaiting response... 301 Moved Permanently
Location: http://www.google.ie/ [following]
--2018-10-02 10:09:51--  http://www.google.ie/
Resolving www.google.ie (www.google.ie)... 74.125.90.67, 2a00:1450:400b:803::2003
Reusing existing connection to google.ie:80.
HTTP request sent, awaiting response... 200 OK
Length: unspecified [text/html]
Saving to: &#39;index.html.1&#39;

    [ &lt;=&gt;                                   ] 11,694      --.-K/s   in 0s      

2018-10-02 10:09:51 (22.4 MB/s) - &#39;index.html.1&#39; saved [11694]</code></pre>
<p>As above, the web request for google.ie worked. This is because your DBServer VM is routed to the internet via the default gateway which is on the network used by vagrant to connect to your machine(10.0.2.0/24). </p>
<ul>
<li>Use the <code>route</code> command to view the IP routing table for the DB Server.</li>
</ul>
<pre><code class="lang-bash">vagrant@dbserver:~$ route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
default         10.0.2.2        0.0.0.0         UG    0      0        0 eth0
10.0.1.128      *               255.255.255.128 U     0      0        0 eth1
10.0.2.0        *               255.255.255.0   U     0      0        0 eth0</code></pre>
<p>From the routing table you can see that all traffic for 10.0.1.128/23 is routed on interface eth1,traffic for 10.0.2.0/24 is routed to eth0, and all other IP traffic is routed to the default gateway 10.0.2.2(the ip address of the VirtualBox NAT router) on interface eth0.
The connection to this router via the 10.0.2.0/24 network is required for  Vagrant to work properly. However, we can remove the default route entry in the routing table. This will prevent any traffic being routed to external public networks and will &quot;simulate&quot; an isolated DB Server. We can use the <code>ip route</code> command to manipulate the routing table of the VM.
- Remove the default route from the routing table of the DB Server</p>
<pre><code class="lang-bash">vagrant@dbserver:~$ sudo ip route del default</code></pre>
<ul>
<li>Repeat the Google.ie request - it should now fail<pre><code class="lang-bash">vagrant@dbserver:~$ sudo ip route del default
vagrant@dbserver:~$ wget google.ie
--2018-10-02 10:28:05--  http://google.ie/
Resolving google.ie (google.ie)... 2a00:1450:400b:803::2003, 74.125.90.67
Connecting to google.ie (google.ie)|2a00:1450:400b:803::2003|:80... failed: Network is unreachable.
Connecting to google.ie (google.ie)|74.125.90.67|:80... failed: Network is unreachable.</code></pre>
Now try to ping the Web Server from the DB server. You&#39;ll notice that, with the removal of the default route, any traffic for 10.0.1.0/25 does not have a valid entry in the route table. To create a route, we need to create an entry in the routing table that forwards all traffic for 10.0.1.0/25 to the interface address of virtual router(10.0.2.2 in this case)</li>
<li>Add an entry to the DBResver routing table that forwards all traffic for 10.0.1.0/25 via 10.0.2.2<pre><code class="lang-bash">vagrant@dbserver:~$ sudo ip route add 10.0.1.0/25 via 10.0.2.2</code></pre>
</li>
</ul>
<p>Now the DB Server cannot route to the internet however it is still possible to connect to devices on the Web Server network. </p>
<h2>Provision the changes</h2>
<p>At the moment, all routing changes made here will be lost if you restart the VMs, or if you halt and restart this Vagrant project. To make sure the routing table changes happen every time you restart the Vagrant Project, you can put them in a script and include a reference to it in the Vagrantfile:
- Create a file called <code>routing.sh</code> in the vagrant project directory with the following contents:</p>
<pre><code class="lang-bash">#!/bin/sh

# update routing for DB Server
sudo ip route del default
sudo ip route add 10.0.1.0/25 via 10.0.2.2</code></pre>
<ul>
<li>Update the Vagrantfile to provision the DB Server using the routing.sh shell script.</li>
</ul>
<pre><code class="lang-shell">VAGRANTFILE_API_VERSION = &quot;2&quot;
Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|
    config.vm.define &quot;WebServer&quot; do |pc0|
        pc0.vm.hostname = &quot;WebServer&quot;
        pc0.vm.network :private_network, ip: &quot;10.0.1.2/23&quot;, :netmask =&gt; &quot;255.255.255.128&quot;
        # Public Network 
        pc0.vm.network &quot;public_network&quot;
    end
    config.vm.define &quot;DBServer&quot; do |pc1|
        pc1.vm.hostname = &quot;DBServer&quot;
        pc1.vm.network :private_network, ip: &quot;10.0.1.130/23&quot;, :netmask =&gt; &quot;255.255.255.128&quot;     
        # Provision the DB Server by executing the routing.sh script
        pc1.vm.provision :shell, path: &quot;routing.sh&quot;
    end
    config.vm.box = &quot;frankwalsh/labvm&quot;
    config.ssh.forward_x11 = true
end</code></pre>
<p>Now stop and start the vagrant project and check that the DB Server does not route to the internet.</p>
</li>
        
      </ul>
    </div>

    <script>
      $(document).ready(function() {
  const $images = $('.lab img');
  jQuery.each($images, function(i) {
    if ($images[i].alt.length > 0) {
      const divImg = $(document.createElement('div')).addClass('');
      $($images[i]).wrap(divImg);
      const divLabel = $(document.createElement('div')).addClass('uk-label uk-text-lowercase');
      divLabel.append($images[i].alt);
      $(divLabel).insertAfter($images[i]);
      $('<br>').insertAfter($images[i]);
    }
  });
});

    </script>
  </body>
</html>